---
layout: full
title: OpenTechSchool Locator
---
 <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
 <style type="text/css" media="screen">
   #map { height: 480px; }
   .event.hidden {
    opacity: 0.5;
   }
 </style>

<div id="map"></div>

<div class="container container_narrow">
  <div id="eventsList"></div>
</div>

<script type="text/x-template" data-template="event">
    <p class="team">${</p>
    <h3 class="post_title"><a href="${link}">${name}</a></h3>
    <p class="date">
      <span>${date}</span>
    </p>
    <p>${venue}</p> <!-- Venue as text -->
</script>


<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js" type="text/javascript" charset="utf-8"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/react/0.8.0/react.js" type="text/javascript" charset="utf-8"></script>

<script type="text/x-template" data-template="marker-popup">
  <a href="${link}">${name}</a><br/>
  <span>${members} Learners</span> in <span>${city}</span>
</script>

<script type="text/javascript" charset="utf-8">
  $(function() {
    var map = L.map('map').setView([52.5167, 13.3833], 1),
        groups = [],
        markers = [],
        position_found = false;
        meetupcom_key = '38406b383fa43605b6b234269316',
        tiles = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                  attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                  maxZoom: 16
                }),
        blueIcon = L.icon({
            iconUrl: '/images/map/marker-blue.png',
            shadowUrl: '/images/map/marker-shadow.png',
            iconSize: [35, 45],
            iconAnchor: [17, 42],
            popupAnchor: [1, -32],
            shadowAnchor: [10, 12],
            shadowSize: [36, 16],
        }),
        redIcon = L.icon({
            iconUrl: '/images/map/marker-red.png',
            //shadowUrl: '/images/map/marker-shadow-mini.png',
            iconSize: [15, 20],
            //iconAnchor: [8, 42],
            popupAnchor: [1, -10],
            //shadowAnchor: [0, 20],
            //shadowSize: [15, 20],
        })

    tiles.addTo(map);

    function zoom_to_closest(){
      var best_marker = null,
          title,
          cur_pos = L.latLng(position_found.latlng),
          best_distance = Infinity;

      $.each(markers, function(index, marker){
        var my_distance = marker.getLatLng().distanceTo(cur_pos);
        if (my_distance < best_distance){
          best_distance = my_distance;
          best_marker = marker;
        }
      });

      title = "Great. You are just " + (best_distance / 1000).toFixed() + " km from the next closest Team: " + best_marker.title;

      if (best_distance < 1000){
        title = "Great. You are just " + best_distance.toFixed() + " meters from the next closest Team: " + best_marker.title;
      } else if (best_distance > 100000){
        title = 'Sorry, there is no OpenTechSchool around. How about <a href="/handbooks/city-blueprint.html">starting your own one</a>?';

      }

      L.marker(cur_pos, {icon: redIcon}).addTo(map)
          .bindPopup(title).openPopup();
      map.fitBounds(L.latLngBounds([cur_pos, best_marker.getLatLng()]).pad(1));
      

    }

    map.on('locationfound', function(e) {
      position_found = e;
      if (markers.length){
        zoom_to_closest();
      }
    });

    map.locate();

    
    var req = $.getJSON('https://api.meetup.com/find/groups?callback=?', {
      key: meetupcom_key,
      sign: true,
      text: 'opentechschool',
      radius: 'global',
      page: 200
    });

    req.then(function(data){
      markers = $.map(data.data, function(group){
        var marker = L.marker([group.lat, group.lon], {
            title: group.name,
            icon: blueIcon
          })
          .addTo(map)
          .bindPopup(OTS.template('marker-popup', group));
          marker.title = group.name;
        return marker;
      });

      if(position_found) {
        zoom_to_closest();
      }

    });

    var Event = React.createClass({
        in_box: function() {
          var ev = this.props.event,
              bb = this.props.boundingBox;
          if (!bb) return true; // we always are in without any bounding box
          console.log(ev.group);
          if (!ev.group.latLng){
            ev.group.latLng = L.latLng(ev.group.group_lat, ev.group.group_lon)
          }

          return bb.contains(ev.group.latLng);
        },
        render: function() {
          var cal_event = this.props.event,
              in_box = this.in_box();

          return React.DOM.div({className: in_box ? "event" : "event hidden"}, [
                    React.DOM.p({className:"team"}, cal_event.group.name),
                    React.DOM.h3({className: "post_title"},
                        React.DOM.a({href: cal_event.event_url}, cal_event.name)),
                    React.DOM.p({className:"date"},
                        React.DOM.span({},
                          moment(new Date(cal_event.time)).format('dddd, MMM Do, HH:mm'))
                        ),
                    React.DOM.p({},
                        cal_event.venue ? cal_event.venue.name : "TBA")
                  ]);
        }
      });

    var EventsList = React.createClass({
          render: function() {
            if (!this.props.events) {return;}
            var eventNodes = this.props.events.map(function (event) {
              return Event({event: event, boundingBox: this.props.boundingBox});
            }.bind(this));
            return React.DOM.div({className:"eventsList",
              children: eventNodes});
          }
        });

    // var Filters = React.createClass({
    //   render: function() {
    //       if (!this.props.data) {return;}
    //       var me = this,
    //           filterNodes = this.props.data.map(function (filter, idx) {
    //             return React.DOM.div({className: "filter"}, [
    //                       React.DOM.span({}, filter.name),
    //                       React.DOM.span({className: "close",
    //                           onClick: function() {me.props.removeFilter(idx);}
    //                         }, "x")
    //                     ]);
    //           });

    //       return React.DOM.div({className:"filterList"}, filterNodes);
    //     }
    //   })
    var EventsBox = React.createClass({
          loadCommentsFromServer: function() {
            $.getJSON('https://api.meetup.com/2/open_events?callback=?', {
                key: meetupcom_key,
                sign: true,
                text: 'opentechschool',
                page: 200
              }).then(function(data){
                    this.setState({events: data.results});
                  }.bind(this)
              );
          },
          getInitialState: function() {
            return {events: [], filters: [], boundingBox: null};
          },
          componentWillMount: function() {
            this.loadCommentsFromServer();
          },
          // removeFilter: function(filterIdx){
          //   var filters = this.state.filters;
          //   filters.pop(filterIdx);
          //   this.setState({filters: filters});
          // },
          // addFilter: function(filterData){
          //   var filters = this.state.filters;
          //   filters.push(filterData);
          //   this.setState({filters: filters});
          // },
          setGroups: function(groups){
            this.setState({groups: groups});
          },
          render: function() {
            return React.DOM.div({className:"eventsBox",
              children:[
                React.DOM.h1({children:"Upcoming Events"}),
                //Filters({data: this.state.filters, removeFilter: this.removeFilter.bind(this)}),
                EventsList({events: this.state.events,
                            boundingBox:this.state.boundingBox})
              ]});
          }
        });
    var eventsBox = React.renderComponent(EventsBox(),
      document.getElementById('eventsList')
    );

    map.on("moveend", function(){
      eventsBox.setState({"boundingBox": map.getBounds()})
    });
  });
</script>
